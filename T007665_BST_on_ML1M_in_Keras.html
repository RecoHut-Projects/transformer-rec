
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A Transformer-based recommendation system &#8212; transformer-rec</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning" href="T881207_BST_PTLightning_ML1M.html" />
    <link rel="prev" title="BST implementation in PyTorch" href="T602245_BST_implementation_in_PyTorch.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">transformer-rec</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="US780867_Transformer_based_Recommenders.html">
   Transformer-based Recommenders
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T034923_BERT4Rec_on_ML1M_in_PyTorch.html">
   BERT4Rec on ML-1M in PyTorch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T595874_BERT4Rec_on_ML25M_in_PyTorch_Lightning.html">
   BERT4Rec on ML-25M
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T088416_BST_Implementation_in_MXNet.html">
   BST Implementation in MXNet
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T602245_BST_implementation_in_PyTorch.html">
   BST implementation in PyTorch
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   A Transformer-based recommendation system
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T881207_BST_PTLightning_ML1M.html">
   Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T025247_BST_using_Deepctr_library.html">
   BST using Deepctr library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T757997_SASRec_PyTorch.html">
   SASRec implementation with PyTorch Library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T225287_SASRec_PaddlePaddle.html">
   SASRec implementation with Paddle Library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T701627_SR_SAN_Session_based_Model.html">
   SR-SAN Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T975104_SSEPT_ML1M_Tensorflow1x.html">
   SSE-PT Personalized Transformer Recommender on ML-1M in Tensorflow 1.x
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T472955_GCSAN_Session_based_Model.html">
   GCSAN Session-based Recommender
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T970274_Transformers4Rec_Session_based_Recommender_on_Yoochoose.html">
   End-to-end session-based recommendation with Transformers4Rec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T382183_Transformers4Rec_XLNet_on_Synthetic_data.html">
   Transformers4Rec XLNet on Synthetic data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T793395_Session_based_recommendation_on_REES46_Dataset.html">
   End-to-end Session-based recommendation on REES46 Dataset
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T007665_BST_on_ML1M_in_Keras.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/transformer-rec/main?urlpath=lab/tree/docs/T007665_BST_on_ML1M_in_Keras.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/transformer-rec/blob/main/docs/T007665_BST_on_ML1M_in_Keras.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-dataset">
   The dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prepare-the-data">
   Prepare the data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-and-prepare-the-dataframes">
     Download and prepare the DataFrames
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#transform-the-movie-ratings-data-into-sequences">
     Transform the movie ratings data into sequences
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-metadata">
   Define metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-tf-data-dataset-for-training-and-evaluation">
   Create
   <code class="docutils literal notranslate">
    <span class="pre">
     tf.data.Dataset
    </span>
   </code>
   for training and evaluation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-model-inputs">
   Create model inputs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#encode-input-features">
   Encode input features
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-a-bst-model">
   Create a BST model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-training-and-evaluation-experiment">
   Run training and evaluation experiment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><a href="https://colab.research.google.com/github/sparsh-ai/reco-book/blob/stage/nbs/movielens_recommendations_transformers.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<div class="section" id="a-transformer-based-recommendation-system">
<h1>A Transformer-based recommendation system<a class="headerlink" href="#a-transformer-based-recommendation-system" title="Permalink to this headline">¶</a></h1>
<p><strong>Author:</strong> <a class="reference external" href="https://www.linkedin.com/in/khalid-salama-24403144/">Khalid Salama</a><br>
<strong>Date created:</strong> 2020/12/30<br>
<strong>Last modified:</strong> 2020/12/30<br>
<strong>Description:</strong> Rating rate prediction using the Behavior Sequence Transformer (BST) model on the Movielens.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This example demonstrates the <a class="reference external" href="https://arxiv.org/abs/1905.06874">Behavior Sequence Transformer (BST)</a>
model, by Qiwei Chen et al., using the <a class="reference external" href="https://grouplens.org/datasets/movielens/">Movielens dataset</a>.
The BST model leverages the sequential behaviour of the users in watching and rating movies,
as well as user profile and movie features, to predict the rating of the user to a target movie.</p>
<p>More precisely, the BST model aims to predict the rating of a target movie by accepting
the following inputs:</p>
<ol class="simple">
<li><p>A fixed-length <em>sequence</em> of <code class="docutils literal notranslate"><span class="pre">movie_ids</span></code> watched by a user.</p></li>
<li><p>A fixed-length <em>sequence</em> of the <code class="docutils literal notranslate"><span class="pre">ratings</span></code> for the movies watched by a user.</p></li>
<li><p>A <em>set</em> of user features, including <code class="docutils literal notranslate"><span class="pre">user_id</span></code>, <code class="docutils literal notranslate"><span class="pre">sex</span></code>, <code class="docutils literal notranslate"><span class="pre">occupation</span></code>, and <code class="docutils literal notranslate"><span class="pre">age_group</span></code>.</p></li>
<li><p>A <em>set</em> of <code class="docutils literal notranslate"><span class="pre">genres</span></code> for each movie in the input sequence and the target movie.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">target_movie_id</span></code> for which to predict the rating.</p></li>
</ol>
<p>This example modifies the original BST model in the following ways:</p>
<ol class="simple">
<li><p>We incorporate the movie features (genres) into the processing of the embedding of each
movie of the input sequence and the target movie, rather than treating them as “other features”
outside the transformer layer.</p></li>
<li><p>We utilize the ratings of movies in the input sequence, along with the their positions
in the sequence, to update them before feeding them into the self-attention layer.</p></li>
</ol>
<p>Note that this example should be run with TensorFlow 2.4 or higher.</p>
</div>
<div class="section" id="the-dataset">
<h2>The dataset<a class="headerlink" href="#the-dataset" title="Permalink to this headline">¶</a></h2>
<p>We use the <a class="reference external" href="https://grouplens.org/datasets/movielens/1m/">1M version of the Movielens dataset</a>.
The dataset includes around 1 million ratings from 6000 users on 4000 movies,
along with some user features, movie genres. In addition, the timestamp of each user-movie
rating is provided, which allows creating sequences of movie ratings for each user,
as expected by the BST model.</p>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">StringLookup</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="prepare-the-data">
<h2>Prepare the data<a class="headerlink" href="#prepare-the-data" title="Permalink to this headline">¶</a></h2>
<div class="section" id="download-and-prepare-the-dataframes">
<h3>Download and prepare the DataFrames<a class="headerlink" href="#download-and-prepare-the-dataframes" title="Permalink to this headline">¶</a></h3>
<p>First, let’s download the movielens data.</p>
<p>The downloaded folder will contain three data files: <code class="docutils literal notranslate"><span class="pre">users.dat</span></code>, <code class="docutils literal notranslate"><span class="pre">movies.dat</span></code>,
and <code class="docutils literal notranslate"><span class="pre">ratings.dat</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlretrieve</span><span class="p">(</span><span class="s2">&quot;http://files.grouplens.org/datasets/movielens/ml-1m.zip&quot;</span><span class="p">,</span> <span class="s2">&quot;movielens.zip&quot;</span><span class="p">)</span>
<span class="n">ZipFile</span><span class="p">(</span><span class="s2">&quot;movielens.zip&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we load the data into pandas DataFrames with their proper column names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;ml-1m/users.dat&quot;</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age_group&quot;</span><span class="p">,</span> <span class="s2">&quot;occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;zip_code&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;ml-1m/ratings.dat&quot;</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;movie_id&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="s2">&quot;unix_timestamp&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;ml-1m/movies.dat&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;genres&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here, we do some simple data processing to fix the data types of the columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">users</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;user_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">users</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="s2">&quot;age_group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;group_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">users</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="s2">&quot;occupation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;occupation_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">movies</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;movie_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;movie_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;user_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Each movie has multiple genres. We split them into separate columns in the <code class="docutils literal notranslate"><span class="pre">movies</span></code>
DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">genres</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Action&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adventure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Animation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Children&#39;s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Comedy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Crime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Documentary&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Drama&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Film-Noir&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Horror&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Musical&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mystery&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Romance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sci-Fi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Thriller&quot;</span><span class="p">,</span>
    <span class="s2">&quot;War&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Western&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">:</span>
    <span class="n">movies</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;genres&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">values</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">genre</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">))</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="transform-the-movie-ratings-data-into-sequences">
<h3>Transform the movie ratings data into sequences<a class="headerlink" href="#transform-the-movie-ratings-data-into-sequences" title="Permalink to this headline">¶</a></h3>
<p>First, let’s sort the the ratings data using the <code class="docutils literal notranslate"><span class="pre">unix_timestamp</span></code>, and then group the
<code class="docutils literal notranslate"><span class="pre">movie_id</span></code> values and the <code class="docutils literal notranslate"><span class="pre">rating</span></code> values by <code class="docutils literal notranslate"><span class="pre">user_id</span></code>.</p>
<p>The output DataFrame will have a record for each <code class="docutils literal notranslate"><span class="pre">user_id</span></code>, with two ordered lists
(sorted by rating datetime): the movies they have rated, and their ratings of these movies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings_group</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;unix_timestamp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>

<span class="n">ratings_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings_group</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="s2">&quot;movie_ids&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings_group</span><span class="o">.</span><span class="n">movie_id</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)),</span>
        <span class="s2">&quot;ratings&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings_group</span><span class="o">.</span><span class="n">rating</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)),</span>
        <span class="s2">&quot;timestamps&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings_group</span><span class="o">.</span><span class="n">unix_timestamp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)),</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s split the <code class="docutils literal notranslate"><span class="pre">movie_ids</span></code> list into a set of sequences of a fixed length.
We do the same for the <code class="docutils literal notranslate"><span class="pre">ratings</span></code>. Set the <code class="docutils literal notranslate"><span class="pre">sequence_length</span></code> variable to change the length
of the input sequence to the model. You can also change the <code class="docutils literal notranslate"><span class="pre">step_size</span></code> to control the
number of sequences to generate for each user.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sequence_length</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">step_size</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">create_sequences</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">window_size</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">end_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window_size</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="n">window_size</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">==</span> <span class="n">window_size</span><span class="p">:</span>
                <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="n">start_index</span> <span class="o">+=</span> <span class="n">step_size</span>
    <span class="k">return</span> <span class="n">sequences</span>


<span class="n">ratings_data</span><span class="o">.</span><span class="n">movie_ids</span> <span class="o">=</span> <span class="n">ratings_data</span><span class="o">.</span><span class="n">movie_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">ids</span><span class="p">:</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ratings_data</span><span class="o">.</span><span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings_data</span><span class="o">.</span><span class="n">ratings</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">ids</span><span class="p">:</span> <span class="n">create_sequences</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">del</span> <span class="n">ratings_data</span><span class="p">[</span><span class="s2">&quot;timestamps&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>After that, we process the output to have each sequence in a separate records in
the DataFrame. In addition, we join the user features with the ratings data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ratings_data_movies</span> <span class="o">=</span> <span class="n">ratings_data</span><span class="p">[[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;movie_ids&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span>
    <span class="s2">&quot;movie_ids&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">ratings_data_rating</span> <span class="o">=</span> <span class="n">ratings_data</span><span class="p">[[</span><span class="s2">&quot;ratings&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;ratings&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ratings_data_transformed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ratings_data_movies</span><span class="p">,</span> <span class="n">ratings_data_rating</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ratings_data_transformed</span> <span class="o">=</span> <span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">users</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span>
<span class="p">)</span>
<span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">movie_ids</span> <span class="o">=</span> <span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">movie_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">ratings</span> <span class="o">=</span> <span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">ratings</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
<span class="p">)</span>

<span class="k">del</span> <span class="n">ratings_data_transformed</span><span class="p">[</span><span class="s2">&quot;zip_code&quot;</span><span class="p">]</span>

<span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;movie_ids&quot;</span><span class="p">:</span> <span class="s2">&quot;sequence_movie_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;ratings&quot;</span><span class="p">:</span> <span class="s2">&quot;sequence_ratings&quot;</span><span class="p">},</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">sequence_length</span></code> of 4 and <code class="docutils literal notranslate"><span class="pre">step_size</span></code> of 2, we end up with 498,623 sequences.</p>
<p>Finally, we split the data into training and testing splits, with 85% and 15% of
the instances, respectively, and store them to CSV files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">random_selection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mf">0.85</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">ratings_data_transformed</span><span class="p">[</span><span class="n">random_selection</span><span class="p">]</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">ratings_data_transformed</span><span class="p">[</span><span class="o">~</span><span class="n">random_selection</span><span class="p">]</span>

<span class="n">train_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;train_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;test_data.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="define-metadata">
<h2>Define metadata<a class="headerlink" href="#define-metadata" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CSV_HEADER</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ratings_data_transformed</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">CATEGORICAL_FEATURES_WITH_VOCABULARY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
    <span class="s2">&quot;movie_id&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">movie_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
    <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">sex</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
    <span class="s2">&quot;age_group&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">age_group</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
    <span class="s2">&quot;occupation&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">occupation</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
<span class="p">}</span>

<span class="n">USER_FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age_group&quot;</span><span class="p">,</span> <span class="s2">&quot;occupation&quot;</span><span class="p">]</span>

<span class="n">MOVIE_FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;genres&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-tf-data-dataset-for-training-and-evaluation">
<h2>Create <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> for training and evaluation<a class="headerlink" href="#create-tf-data-dataset-for-training-and-evaluation" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_dataset_from_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
        <span class="n">movie_ids_string</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s2">&quot;sequence_movie_ids&quot;</span><span class="p">]</span>
        <span class="n">sequence_movie_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">movie_ids_string</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">()</span>

        <span class="c1"># The last movie id in the sequence is the target movie.</span>
        <span class="n">features</span><span class="p">[</span><span class="s2">&quot;target_movie_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_movie_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s2">&quot;sequence_movie_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_movie_ids</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ratings_string</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s2">&quot;sequence_ratings&quot;</span><span class="p">]</span>
        <span class="n">sequence_ratings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">to_number</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ratings_string</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">float32</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">()</span>

        <span class="c1"># The last rating in the sequence is the target for the model to predict.</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">sequence_ratings</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">features</span><span class="p">[</span><span class="s2">&quot;sequence_ratings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence_ratings</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="n">target</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_csv_dataset</span><span class="p">(</span>
        <span class="n">csv_file_path</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">column_names</span><span class="o">=</span><span class="n">CSV_HEADER</span><span class="p">,</span>
        <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">field_delim</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-model-inputs">
<h2>Create model inputs<a class="headerlink" href="#create-model-inputs" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_model_inputs</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
        <span class="s2">&quot;sequence_movie_ids&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sequence_movie_ids&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span>
        <span class="p">),</span>
        <span class="s2">&quot;target_movie_id&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;target_movie_id&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span>
        <span class="p">),</span>
        <span class="s2">&quot;sequence_ratings&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sequence_ratings&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">sequence_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
        <span class="p">),</span>
        <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
        <span class="s2">&quot;age_group&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;age_group&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
        <span class="s2">&quot;occupation&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;occupation&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="encode-input-features">
<h2>Encode input features<a class="headerlink" href="#encode-input-features" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">encode_input_features</span></code> method works as follows:</p>
<ol class="simple">
<li><p>Each categorical user feature is encoded using <code class="docutils literal notranslate"><span class="pre">layers.Embedding</span></code>, with embedding
dimension equals to the square root of the vocabulary size of the feature.
The embeddings of these features are concatenated to form a single input tensor.</p></li>
<li><p>Each movie in the movie sequence and the target movie is encoded <code class="docutils literal notranslate"><span class="pre">layers.Embedding</span></code>,
where the dimension size is the square root of the number of movies.</p></li>
<li><p>A multi-hot genres vector for each movie is concatenated with its embedding vector,
and processed using a non-linear <code class="docutils literal notranslate"><span class="pre">layers.Dense</span></code> to output a vector of the same movie
embedding dimensions.</p></li>
<li><p>A positional embedding is added to each movie embedding in the sequence, and then
multiplied by its rating from the ratings sequence.</p></li>
<li><p>The target movie embedding is concatenated to the sequence movie embeddings, producing
a tensor with the shape of <code class="docutils literal notranslate"><span class="pre">[batch</span> <span class="pre">size,</span> <span class="pre">sequence</span> <span class="pre">length,</span> <span class="pre">embedding</span> <span class="pre">size]</span></code>, as expected
by the attention layer for the transformer architecture.</p></li>
<li><p>The method returns a tuple of two elements:  <code class="docutils literal notranslate"><span class="pre">encoded_transformer_features</span></code> and
<code class="docutils literal notranslate"><span class="pre">encoded_other_features</span></code>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">encode_input_features</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">,</span>
    <span class="n">include_user_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">include_user_features</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">include_movie_features</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">encoded_transformer_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">encoded_other_features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">other_feature_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include_user_id</span><span class="p">:</span>
        <span class="n">other_feature_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_user_features</span><span class="p">:</span>
        <span class="n">other_feature_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">USER_FEATURES</span><span class="p">)</span>

    <span class="c1">## Encode user features</span>
    <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">other_feature_names</span><span class="p">:</span>
        <span class="c1"># Convert the string input values into integer indices.</span>
        <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">CATEGORICAL_FEATURES_WITH_VOCABULARY</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">StringLookup</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">,</span> <span class="n">mask_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_oov_indices</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
            <span class="n">inputs</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Compute embedding dimensions</span>
        <span class="n">embedding_dims</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">)))</span>
        <span class="c1"># Create an embedding layer with the specified dimensions.</span>
        <span class="n">embedding_encoder</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">),</span>
            <span class="n">output_dim</span><span class="o">=</span><span class="n">embedding_dims</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">_embedding&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Convert the index values to embedding representations.</span>
        <span class="n">encoded_other_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embedding_encoder</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

    <span class="c1">## Create a single embedding vector for the user features</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_other_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">encoded_other_features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">encoded_other_features</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_other_features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">encoded_other_features</span> <span class="o">=</span> <span class="n">encoded_other_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">encoded_other_features</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">## Create a movie embedding encoder</span>
    <span class="n">movie_vocabulary</span> <span class="o">=</span> <span class="n">CATEGORICAL_FEATURES_WITH_VOCABULARY</span><span class="p">[</span><span class="s2">&quot;movie_id&quot;</span><span class="p">]</span>
    <span class="n">movie_embedding_dims</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_vocabulary</span><span class="p">)))</span>
    <span class="c1"># Create a lookup to convert string values to integer indices.</span>
    <span class="n">movie_index_lookup</span> <span class="o">=</span> <span class="n">StringLookup</span><span class="p">(</span>
        <span class="n">vocabulary</span><span class="o">=</span><span class="n">movie_vocabulary</span><span class="p">,</span>
        <span class="n">mask_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">num_oov_indices</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;movie_index_lookup&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Create an embedding layer with the specified dimensions.</span>
    <span class="n">movie_embedding_encoder</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">movie_vocabulary</span><span class="p">),</span>
        <span class="n">output_dim</span><span class="o">=</span><span class="n">movie_embedding_dims</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;movie_embedding&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Create a vector lookup for movie genres.</span>
    <span class="n">genre_vectors</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="n">genres</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">movie_genres_lookup</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">genre_vectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">output_dim</span><span class="o">=</span><span class="n">genre_vectors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">embeddings_initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">genre_vectors</span><span class="p">),</span>
        <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;genres_vector&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Create a processing layer for genres.</span>
    <span class="n">movie_embedding_processor</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
        <span class="n">units</span><span class="o">=</span><span class="n">movie_embedding_dims</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;process_movie_embedding_with_genres&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">## Define a function to encode a given movie id.</span>
    <span class="k">def</span> <span class="nf">encode_movie</span><span class="p">(</span><span class="n">movie_id</span><span class="p">):</span>
        <span class="c1"># Convert the string input values into integer indices.</span>
        <span class="n">movie_idx</span> <span class="o">=</span> <span class="n">movie_index_lookup</span><span class="p">(</span><span class="n">movie_id</span><span class="p">)</span>
        <span class="n">movie_embedding</span> <span class="o">=</span> <span class="n">movie_embedding_encoder</span><span class="p">(</span><span class="n">movie_idx</span><span class="p">)</span>
        <span class="n">encoded_movie</span> <span class="o">=</span> <span class="n">movie_embedding</span>
        <span class="k">if</span> <span class="n">include_movie_features</span><span class="p">:</span>
            <span class="n">movie_genres_vector</span> <span class="o">=</span> <span class="n">movie_genres_lookup</span><span class="p">(</span><span class="n">movie_idx</span><span class="p">)</span>
            <span class="n">encoded_movie</span> <span class="o">=</span> <span class="n">movie_embedding_processor</span><span class="p">(</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">movie_embedding</span><span class="p">,</span> <span class="n">movie_genres_vector</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">encoded_movie</span>

    <span class="c1">## Encoding target_movie_id</span>
    <span class="n">target_movie_id</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;target_movie_id&quot;</span><span class="p">]</span>
    <span class="n">encoded_target_movie</span> <span class="o">=</span> <span class="n">encode_movie</span><span class="p">(</span><span class="n">target_movie_id</span><span class="p">)</span>

    <span class="c1">## Encoding sequence movie_ids.</span>
    <span class="n">sequence_movies_ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;sequence_movie_ids&quot;</span><span class="p">]</span>
    <span class="n">encoded_sequence_movies</span> <span class="o">=</span> <span class="n">encode_movie</span><span class="p">(</span><span class="n">sequence_movies_ids</span><span class="p">)</span>
    <span class="c1"># Create positional embedding.</span>
    <span class="n">position_embedding_encoder</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">,</span>
        <span class="n">output_dim</span><span class="o">=</span><span class="n">movie_embedding_dims</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;position_embedding&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">sequence_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">encodded_positions</span> <span class="o">=</span> <span class="n">position_embedding_encoder</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="c1"># Retrieve sequence ratings to incorporate them into the encoding of the movie.</span>
    <span class="n">sequence_ratings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;sequence_ratings&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Add the positional encoding to the movie encodings and multiply them by rating.</span>
    <span class="n">encoded_sequence_movies_with_poistion_and_rating</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Multiply</span><span class="p">()(</span>
        <span class="p">[(</span><span class="n">encoded_sequence_movies</span> <span class="o">+</span> <span class="n">encodded_positions</span><span class="p">),</span> <span class="n">sequence_ratings</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Construct the transformer inputs.</span>
    <span class="k">for</span> <span class="n">encoded_movie</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span>
        <span class="n">encoded_sequence_movies_with_poistion_and_rating</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">):</span>
        <span class="n">encoded_transformer_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">encoded_movie</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">encoded_transformer_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encoded_target_movie</span><span class="p">)</span>

    <span class="n">encoded_transformer_features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="n">encoded_transformer_features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">encoded_transformer_features</span><span class="p">,</span> <span class="n">encoded_other_features</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-a-bst-model">
<h2>Create a BST model<a class="headerlink" href="#create-a-bst-model" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include_user_id</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">include_user_features</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">include_movie_features</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">hidden_units</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<span class="n">dropout_rate</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">num_heads</span> <span class="o">=</span> <span class="mi">3</span>


<span class="k">def</span> <span class="nf">create_model</span><span class="p">():</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">create_model_inputs</span><span class="p">()</span>
    <span class="n">transformer_features</span><span class="p">,</span> <span class="n">other_features</span> <span class="o">=</span> <span class="n">encode_input_features</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">,</span> <span class="n">include_user_id</span><span class="p">,</span> <span class="n">include_user_features</span><span class="p">,</span> <span class="n">include_movie_features</span>
    <span class="p">)</span>

    <span class="c1"># Create a multi-headed attention layer.</span>
    <span class="n">attention_output</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">MultiHeadAttention</span><span class="p">(</span>
        <span class="n">num_heads</span><span class="o">=</span><span class="n">num_heads</span><span class="p">,</span> <span class="n">key_dim</span><span class="o">=</span><span class="n">transformer_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dropout</span><span class="o">=</span><span class="n">dropout_rate</span>
    <span class="p">)(</span><span class="n">transformer_features</span><span class="p">,</span> <span class="n">transformer_features</span><span class="p">)</span>

    <span class="c1"># Transformer block.</span>
    <span class="n">attention_output</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">attention_output</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">transformer_features</span><span class="p">,</span> <span class="n">attention_output</span><span class="p">])</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">x2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">transformer_features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">])</span>
    <span class="n">transformer_features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()(</span><span class="n">transformer_features</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">transformer_features</span><span class="p">)</span>

    <span class="c1"># Included the other features.</span>
    <span class="k">if</span> <span class="n">other_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">features</span><span class="p">,</span> <span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="n">other_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])(</span><span class="n">other_features</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="c1"># Fully-connected layers.</span>
    <span class="k">for</span> <span class="n">num_units</span> <span class="ow">in</span> <span class="n">hidden_units</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_units</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="run-training-and-evaluation-experiment">
<h2>Run training and evaluation experiment<a class="headerlink" href="#run-training-and-evaluation-experiment" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compile the model.</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()],</span>
<span class="p">)</span>

<span class="c1"># Read the training data.</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">get_dataset_from_csv</span><span class="p">(</span><span class="s2">&quot;train_data.csv&quot;</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">265</span><span class="p">)</span>

<span class="c1"># Fit the model with the training data.</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Read the test data.</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">get_dataset_from_csv</span><span class="p">(</span><span class="s2">&quot;test_data.csv&quot;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">265</span><span class="p">)</span>

<span class="c1"># Evaluate the model on the test data.</span>
<span class="n">_</span><span class="p">,</span> <span class="n">rmse</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test MAE: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">rmse</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You should achieve a Mean Absolute Error (MAE) at or around 0.7 on the test data.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>The BST model uses the Transformer layer in its architecture to capture the sequential signals underlying
users’ behavior sequences for recommendation.</p>
<p>You can try training this model with different configurations, for example, by increasing
the input sequence length and training the model for a larger number of epochs. In addition,
you can try including other features like movie release year and customer
zipcode, and including cross features like sex X genre.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/transformer-rec",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T602245_BST_implementation_in_PyTorch.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">BST implementation in PyTorch</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T881207_BST_PTLightning_ML1M.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Rating prediction using the Behavior Sequence Transformer (BST) model on ML-1M dataset in PyTorch Lightning</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>